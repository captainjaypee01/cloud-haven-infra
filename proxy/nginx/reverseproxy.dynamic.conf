# ---------- Global (http context) ----------
resolver 127.0.0.11 ipv6=off valid=10s;
server_tokens off;                        # hide version (leaves "Server: nginx")
# Security headers added on every TLS response
# (HSTS only after you confirm TLS works; includes subdomains; add 'preload' later if you enroll)
map $sent_http_content_type $csp {
    ~*text/html "default-src 'self' https://api.netaniadelaiya.com https://*.clerk.com https://*.cloudinary.com; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; script-src 'self' https://* 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline' https://* https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://api.netaniadelaiya.com https://*.clerk.com wss: https:; frame-src 'self' https://*.clerk.com https://storage.googleapis.com; worker-src 'self' blob: data:; child-src 'self' blob: data:; upgrade-insecure-requests;";
    default "";
}

# Allow only these origins
map $http_origin $cors_origin {
    default "";
    "~^https://www\.netaniadelaiya\.com$" $http_origin;   # prod canonical
    "~^https://uat\.netaniadelaiya\.com$" $http_origin;   # uat (no www)
}

# ---------- PROD WEB ----------
server {
    listen 80;
    server_name netaniadelaiya.com;
    return 301 https://www.netaniadelaiya.com$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    return 301 https://www.netaniadelaiya.com$request_uri;
}

# 3) HTTP www → HTTPS www
server {
    listen 80;
    server_name www.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

# 4) Serve PROD on HTTPS www
server {
    listen 443 ssl;
    http2 on;
    server_name www.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    # security headers (your existing set)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;
    proxy_hide_header Content-Security-Policy;
    add_header Content-Security-Policy $csp always;

    # Cache rules
    #location = /index.html { add_header Cache-Control "no-cache, must-revalidate"; }
    #location /assets/      { expires 1y; add_header Cache-Control "public, immutable"; }

    # frontend-prod
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://frontend-prod:80;
    }

    # safety net for /api
    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend-prod:80;
    }

    client_max_body_size 20m;
}

# ---------- PROD API ----------
server {
    listen 80;
    server_name api.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name api.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    # ------------- NGINX OWNS CORS -------------
    # Drop any upstream CORS to avoid duplicates (Laravel may send '*')
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Expose-Headers;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Methods;

    # Our single canonical CORS set (applies to all responses)
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary "Origin" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers $http_access_control_request_headers always;
    add_header Access-Control-Max-Age "600" always;
    # If you use cookie-based auth, also:
    # add_header Access-Control-Allow-Credentials "true" always;

    location / {
        # Preflight: short-circuit so it never reaches Laravel
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Forward bearer tokens (Clerk) on real requests
        proxy_set_header Authorization $http_authorization;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend-prod:80;
    }

    client_max_body_size 20m;
}

# ---------- UAT WEB (kept; harmless if UAT is down) ----------
server {
    listen 80;
    server_name uat.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name uat.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;
    proxy_hide_header Content-Security-Policy;   # <— ADD THIS

    add_header Content-Security-Policy $csp always;

    set $uat_web "frontend-uat:80";          # <- variable!
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://$uat_web;            # <- variable here
    }

    # safety net for relative /api from UAT web -> still hit prod backend
    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend-prod:80;
    }

    client_max_body_size 20m;
}

# ---------- UAT API ----------
server {
    listen 80;
    server_name uat-api.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name uat-api.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    # ------------- NGINX OWNS CORS -------------
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Expose-Headers;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Allow-Methods;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary "Origin" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers $http_access_control_request_headers always;
    add_header Access-Control-Max-Age "600" always;
    # add_header Access-Control-Allow-Credentials "true" always;  # if you use cookies

    set $uat_api "backend-uat:80";
    location / {
        if ($request_method = OPTIONS) {
            return 204;
        }

        proxy_set_header Authorization $http_authorization;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://$uat_api;
    }

    client_max_body_size 20m;
}
