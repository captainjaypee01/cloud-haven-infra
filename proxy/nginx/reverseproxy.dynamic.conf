# ---------- Global (http context) ----------
resolver 127.0.0.11 ipv6=off valid=10s;
server_tokens off;                        # hide version (leaves "Server: nginx")
# Security headers added on every TLS response
# (HSTS only after you confirm TLS works; includes subdomains; add 'preload' later if you enroll)
map $sent_http_content_type $csp { default "default-src 'self' https://api.netaniadelaiya.com https://*.clerk.com https://*.cloudinary.com; img-src 'self' data: https://*.cloudinary.com https://*.clerk.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self' https://*.clerk.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' https://api.netaniadelaiya.com https://*.clerk.com wss: https:; frame-ancestors 'self'; frame-src  'self' https://*.clerk.com https://storage.googleapis.com; worker-src 'self' blob"; }

# ---------- PROD WEB ----------
server {
    listen 80;
    server_name netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Content-Security-Policy $csp always;
    # CSP (tune as you restrict third parties)
    # add_header Content-Security-Policy "
    #     upgrade-insecure-requests;
    #     default-src 'self';
    #     base-uri 'self';
    #     object-src 'none';
    #     frame-ancestors 'self';
    #     script-src 'self' https://*.clerk.com 'unsafe-inline' 'unsafe-eval';
    #     style-src  'self' 'unsafe-inline' https://fonts.googleapis.com;
    #     font-src   'self' https://fonts.gstatic.com;
    #     img-src    'self' data: https://*.cloudinary.com https://*.clerk.com;
    #     connect-src 'self' https://api.netaniadelaiya.com https://*.clerk.com wss: https:;
    #     frame-src  'self' https://*.clerk.com https://storage.googleapis.com;
    #     worker-src 'self' blob:
    # " always;

    # Donâ€™t leak upstream headers
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;               # hides upstream "Server" from backend; Nginx's own header remains

    # Cache rules
    location = /index.html { add_header Cache-Control "no-cache, must-revalidate"; }
    location /assets/      { expires 1y; add_header Cache-Control "public, immutable"; }

    # Serve frontend
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://frontend-prod:80;
    }

    # Safety net: if the SPA still calls /api/... on same origin, forward to backend
    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend-prod:80;
    }

    client_max_body_size 20m; # adjust for image uploads
}

# ---------- PROD API ----------
server {
    listen 80;
    server_name api.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name api.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend-prod:80;
    }

    client_max_body_size 20m;
}

# ---------- UAT WEB (kept; harmless if UAT is down) ----------
server {
    listen 80;
    server_name uat.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name uat.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Content-Security-Policy $csp always;
    # CSP (tune as you restrict third parties)
    # add_header Content-Security-Policy "
    #     upgrade-insecure-requests;
    #     default-src 'self';
    #     base-uri 'self';
    #     object-src 'none';
    #     frame-ancestors 'self';
    #     script-src 'self' https://*.clerk.com 'unsafe-inline' 'unsafe-eval';
    #     style-src  'self' 'unsafe-inline' https://fonts.googleapis.com;
    #     font-src   'self' https://fonts.gstatic.com;
    #     img-src    'self' data: https://*.cloudinary.com https://*.clerk.com;
    #     connect-src 'self' https://api.netaniadelaiya.com https://*.clerk.com wss: https:;
    #     frame-src  'self' https://*.clerk.com https://storage.googleapis.com;
    #     worker-src 'self' blob:
    # " always;

    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    set $uat_web "frontend-uat:80";          # <- variable!
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://$uat_web;            # <- variable here
    }

    # safety net for relative /api from UAT web -> still hit prod backend
    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://backend-prod:80;
    }

    client_max_body_size 20m;
}

# ---------- UAT API ----------
server {
    listen 80;
    server_name uat-api.netaniadelaiya.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name uat-api.netaniadelaiya.com;

    ssl_certificate     /etc/letsencrypt/live/netaniadelaiya.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/netaniadelaiya.com/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    set $uat_api "backend-uat:80";           # <- variable!
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://$uat_api;            # <- variable here
    }

    client_max_body_size 20m;
}
